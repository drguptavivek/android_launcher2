# Device Registration Documentation

## Overview

The Android Launcher & Admin System uses a token-based device registration workflow that allows administrators to generate temporary 5-digit codes in the web dashboard, which users can then enter in the Android app to register their devices.

## Backend API Documentation

### 1. Generate Registration Code

**Endpoint:** `POST /api/devices/register/generate-code`

**Purpose:** Generated by admin in web dashboard to create a temporary 5-digit registration code

**Request Body:**
```json
{
  "description": "John's Test Phone"
}
```

**Response (201 Created):**
```json
{
  "code": "ABC12",
  "expiresAt": "2024-01-01T10:00:00.000Z"
}
```

**Behavior:**
- Generates a unique 5-character alphanumeric code (0-9, A-Z)
- Code expires after 10 minutes
- Automatically cleans up expired tokens
- Associates device description with the code
- Returns case-insensitive code and expiration timestamp

### 2. Register Device with Code

**Endpoint:** `POST /api/devices/register`

**Purpose:** Called from Android app when user enters 5-digit code

**Request Body:**
```json
{
  "registrationCode": "ABC12",
  "model": "Pixel 7",
  "androidVersion": "13.0"
}
```

**Response (200 OK):**
```json
{
  "status": "success",
  "message": "Device registered successfully",
  "deviceId": 1001,
  "description": "John's Test Phone",
  "registeredAt": "2024-01-01T09:55:00.000Z"
}
```

**Error Responses:**
```json
// Invalid/Expired Code (400 Bad Request)
{
  "status": "error",
  "message": "Invalid or expired registration code"
}

// Missing Required Fields (400 Bad Request)
{
  "error": "Invalid request"
}
```

**Behavior:**
- Validates 5-digit registration code (case-insensitive)
- Creates device record with auto-increment device ID (e.g., 1001, 1002, etc.)
- Deletes used registration token
- Returns device confirmation with server-generated device ID and description

## Database Schema

### Devices Table
```sql
CREATE TABLE devices (
  id INTEGER PRIMARY KEY AUTOINCREMENT,  -- Auto-increment device ID (1001, 1002, etc.)
  model TEXT NOT NULL,                    -- Device model (e.g., "Pixel 7")
  androidVersion TEXT NOT NULL,          -- Android version (e.g., "13.0")
  description TEXT,                      -- Device description from registration token
  registeredAt TIMESTAMP NOT NULL,       -- When device was registered
  lastLogin TIMESTAMP                    -- Last device login timestamp
);
```

### Device Registration Tokens Table
```sql
CREATE TABLE deviceRegistrationTokens (
  id TEXT PRIMARY KEY,                    -- Token unique identifier
  code TEXT UNIQUE NOT NULL,             -- 5-character registration code
  description TEXT,                      -- Admin-provided device description
  expiresAt TIMESTAMP NOT NULL,          -- 10-minute expiration
  createdAt TIMESTAMP NOT NULL           -- When token was created
);
```

## Android Registration Flow Steps

### Step 1: Admin Generates Code (Web Dashboard)
1. Admin logs into SvelteKit admin dashboard
2. Navigates to Devices page
3. Clicks "Add Device" button
4. Enters device description (e.g., "John's Test Phone")
5. Clicks "Generate New Code"
6. Dashboard displays 5-digit code (e.g., "ABC12")
7. Code expires in 10 minutes

### Step 2: User Enters Code in Android App
1. User opens Android launcher app
2. App detects device is not registered
3. Shows registration screen with code input field
4. User enters 5-digit code from admin dashboard
5. App validates format (5 alphanumeric characters)

### Step 3: Android App Collects Device Information
```kotlin
val deviceInfo = DeviceRegistrationRequest(
    registrationCode = userEnteredCode.uppercase(),
    model = Build.MODEL,
    androidVersion = Build.VERSION.RELEASE
)
```

**Required Device Information:**
- **Registration Code**: User-entered 5-digit code (converted to uppercase)
- **Model**: Device model from `Build.MODEL`
- **Android Version**: OS version from `Build.VERSION.RELEASE`

**Note**: Device ID is generated by the server as an auto-increment integer, not sent from Android.

### Step 4: Android App Calls Registration API
```kotlin
// API call to register device
val response = apiService.registerDevice(deviceInfo)

// Handle response
if (response.status == "success") {
    // Save device registration data locally (MUST save both ID and description)
    sessionManager.saveDeviceRegistration(
        deviceId = response.deviceId,        // Server-generated auto-increment ID (e.g., 1001)
        description = response.description,  // Admin-provided description (e.g., "John's Test Phone")
        registeredAt = response.registeredAt
    )

    // Navigate to main app or login flow
    navigateToMainApp()
} else {
    // Show error message to user
    showRegistrationError(response.message)
}
```

### Step 5: Server-Side Registration Processing
1. Server receives registration request
2. Validates 5-digit code format
3. Looks up active registration token in database
4. Checks if code is not expired
5. Creates device record with provided information
6. Deletes used registration token
7. Returns success response with device details

### Step 6: Android App Saves Registration Data
```kotlin
// Save to SharedPreferences/SessionManager
sessionManager.apply {
    saveDeviceId(response.deviceId)
    saveDeviceDescription(response.description)
    saveRegistrationTimestamp(response.registeredAt)
    setDeviceRegistered(true)
}
```

**Saved Device Information:**
- **Device ID**: Server-confirmed unique identifier
- **Description**: Admin-provided device description
- **Registration Timestamp**: When device was registered
- **Registration Status**: Flag indicating device is registered

### Step 7: Post-Registration Flow
1. Android app proceeds to user login or main app interface
2. All subsequent API calls include device ID
3. Telemetry events are associated with registered device
4. Admin dashboard shows device as "Active" with description

## Error Handling Scenarios

### Invalid/Expired Code
- Android app shows error: "Invalid or expired registration code"
- User must contact admin to generate new code
- Admin dashboard codes expire after 10 minutes automatically

### Network Errors
- Android app implements retry logic with exponential backoff
- Shows appropriate error messages for connectivity issues
- Stores pending registration attempt locally for retry

### Already Registered Device
- If device ID already exists, server updates device record
- Preserves existing device associations and telemetry history
- Returns updated device information to Android app

## Security Considerations

### Token Security
- 5-character alphanumeric codes (36^5 = 60M combinations)
- 10-minute expiration window limits attack surface
- Case-insensitive validation improves user experience
- Tokens are single-use (deleted after successful registration)

### Data Protection
- Device IDs are UUIDs, no personal identifiers
- Registration data transmitted over HTTPS
- No sensitive information stored in registration tokens

### Rate Limiting
- Consider implementing rate limiting on code generation endpoint
- Prevent brute force attacks on registration endpoint
- Monitor for suspicious registration patterns

## Integration Points

### Android App Integration
1. **RegistrationScreen**: Handle code input and validation
2. **SessionManager**: Store device registration status and data
3. **ApiService**: Add device registration API call
4. **TelemetryWorker**: Include device ID in all telemetry events

### Backend Integration
1. **Device Registration**: Existing `/api/devices/register` endpoint
2. **Authentication**: Include device ID in login process
3. **Telemetry**: Associate events with registered devices
4. **Admin Dashboard**: Display registered devices with descriptions

This registration system provides a secure, user-friendly way to associate Android devices with the admin system while maintaining privacy and security standards.